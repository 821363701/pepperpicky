__author__ = 'yu'

import requests
import pygal
from BeautifulSoup import BeautifulSoup
from datetime import datetime, timedelta
from util import get_stock_history_by_date, rate
from stock_history import get_history

url_rong = 'http://www.szse.cn/szseWeb/FrontController.szse'


def data_standard(l):
    avg = float(sum(l)/len(l))

    new_l = []
    for i in l:
        new_l.append(i/avg)

    return new_l


def get_rong_sz(stock_code, stock_date):
    r = requests.post(url_rong, {
        'ACTIONID': 7,
        'AJAX': 'AJAX-TRUE',
        'CATALOGID': '1837_xxpl',
        'TABKEY': 'tab1',
        'txtDate': stock_date,
        'txtZqdm': stock_code,
        'REPORT_ACTION': 'search'
    })

    try:
        soup = BeautifulSoup(r.text)
        rong_stock = soup.findAll('tr', {'class': 'cls-data-tr'})[0]
        rongzi_buy, rongzi_balance, rongquan_sell_liang, rongquan_balance_liang, rongquan_balance, rong_all_balance = [i.text for i in rong_stock]
        return rongzi_buy, rongzi_balance, rongquan_sell_liang, rongquan_balance_liang, rongquan_balance, rong_all_balance
    except:
        return None
    finally:
        r.close()


# print get_rong_sz('002230', '2015-09-14')


def calc_rong_svg(stock_code):
    for i in range(100):
        day = datetime.now()+timedelta(days=-i-100)
        date = day.strftime('%Y-%m-%d')

        result = get_rong_sz(stock_code, date)
        if result:
            print '{}\t{}\t{}\t{}\t{}\t{}\t{}'.format(date, result[0], result[1], result[2], result[3], result[4], result[5])


data = '''2015-09-24	25,983,071,655	349,152,980,691	3,220,636	141,193,577	877,395,639	350,030,376,330
2015-09-23	26,460,495,533	348,862,246,310	3,861,672	139,705,445	871,789,392	349,734,035,702
2015-09-22	31,598,565,535	348,373,107,279	2,121,641	136,335,618	876,978,020	349,250,085,299
2015-09-21	27,085,902,018	348,283,136,964	2,113,112	140,131,825	881,665,269	349,164,802,233
2015-09-18	22,042,698,276	347,284,755,690	3,041,200	141,813,513	871,121,963	348,155,877,653
2015-09-17	31,393,490,127	347,868,983,179	16,092,559	152,926,768	899,877,756	348,768,860,935
2015-09-16	25,129,563,898	347,000,896,835	19,328,003	154,196,794	904,946,243	347,905,843,078
2015-09-15	18,181,415,448	345,606,919,457	18,472,073	152,447,942	845,000,006	346,451,919,463
2015-09-14	23,069,430,487	353,518,510,882	20,300,294	150,955,801	876,609,403	354,395,120,285
2015-09-11	21,424,035,917	362,993,260,509	20,292,656	148,720,818	925,756,756	363,919,017,265
2015-09-10	25,666,974,012	364,309,103,755	16,686,214	147,119,791	941,747,016	365,250,850,771
2015-09-09	38,607,572,767	364,974,955,542	30,765,443	155,644,246	996,789,544	365,971,745,086
2015-09-08	22,594,119,361	359,632,889,283	13,914,999	135,702,877	907,893,807	360,540,783,090
2015-09-07	28,367,062,154	359,544,041,278	5,730,107	138,176,013	873,462,157	360,417,503,435
2015-09-02	20,665,732,705	352,887,786,561	4,936,897	141,345,271	889,861,777	353,777,648,338
2015-09-01	21,003,546,587	369,385,950,822	6,315,489	143,823,025	921,316,059	370,307,266,881
2015-08-31	27,111,521,606	382,832,812,309	6,951,820	143,297,873	927,621,583	383,760,433,892
2015-08-28	34,472,692,157	389,119,575,750	8,946,787	142,275,400	935,667,614	390,055,243,364
2015-08-27	26,508,724,141	389,523,776,632	10,187,822	142,450,999	901,224,016	390,425,000,648
2015-08-26	30,565,114,990	401,301,348,852	17,367,728	143,021,354	874,289,506	402,175,638,358
2015-08-25	20,081,701,114	419,653,124,847	10,213,456	136,618,771	859,764,730	420,512,889,577
2015-08-24	19,920,856,527	449,543,942,965	10,473,108	141,105,632	934,923,484	450,478,866,449
2015-08-21	32,367,673,587	475,023,987,344	15,008,228	145,246,304	1,080,805,032	476,104,792,376
2015-08-20	39,502,051,987	484,584,219,079	31,735,799	162,615,934	1,163,145,932	485,747,365,011
2015-08-19	45,349,832,025	486,440,616,365	16,109,091	141,146,342	1,109,871,209	487,550,487,574
2015-08-18	58,970,585,163	488,823,492,890	13,660,962	139,440,162	1,094,765,773	489,918,258,663
2015-08-17	52,161,225,982	494,723,065,282	35,783,677	138,732,262	1,078,366,750	495,801,432,032
2015-08-14	51,053,086,391	488,766,646,815	1,204,481	106,302,528	895,942,766	489,662,589,581
2015-08-13	43,735,207,631	486,695,514,736	1,571,500	107,186,090	903,864,538	487,599,379,274
2015-08-12	42,136,857,991	481,886,311,617	810,900	108,653,651	897,773,324	482,784,084,941
2015-08-11	55,588,142,308	481,040,889,023	1,856,400	111,523,948	925,535,339	481,966,424,362
2015-08-10	52,704,540,514	475,981,646,428	1,191,900	115,487,244	951,636,002	476,933,282,430
2015-08-07	36,723,775,989	468,603,376,994	1,410,500	121,109,158	951,763,628	469,555,140,622
2015-08-06	26,900,258,682	465,555,351,702	1,619,600	125,981,284	957,821,954	466,513,173,656
2015-08-05	38,285,992,283	466,810,514,866	1,398,208	128,981,526	987,589,681	467,798,104,547
2015-08-04	39,427,026,777	467,269,519,933	5,529,842	131,326,368	1,025,030,861	468,294,550,794
2015-08-03	24,653,238,452	461,334,491,176	88,481,048	136,285,888	988,706,319	462,323,197,495
2015-07-31	28,500,813,107	475,446,028,932	164,324,543	139,057,556	1,008,473,556	476,454,502,488
2015-07-30	44,962,762,796	486,249,919,886	204,341,485	139,970,844	1,007,357,911	487,257,277,797
2015-07-29	40,350,428,447	487,438,624,110	180,194,248	135,926,756	1,019,504,082	488,458,128,192
2015-07-28	43,301,800,582	491,838,698,549	201,445,510	129,527,120	952,151,347	492,790,849,896
2015-07-27	56,645,261,825	507,551,673,784	200,074,668	141,507,561	1,005,867,563	508,557,541,347
2015-07-24	66,398,135,946	513,599,336,968	181,174,800	143,431,074	1,120,970,976	514,720,307,944
2015-07-23	61,035,857,013	514,057,673,710	167,605,400	137,303,845	1,131,303,311	515,188,977,021
2015-07-22	54,725,753,237	507,535,705,730	127,384,621	140,326,562	1,112,220,421	508,647,926,151
2015-07-21	49,099,274,153	504,055,215,370	130,410,016	133,435,324	1,080,466,093	505,135,681,463
2015-07-20	57,497,327,280	502,482,065,141	112,232,060	117,320,535	992,711,582	503,474,776,723
2015-07-17	50,845,309,187	504,255,441,761	81,385,359	113,256,589	976,975,991	505,232,417,752
2015-07-16	43,527,711,140	500,271,915,831	88,479,426	108,598,009	903,823,293	501,175,739,124
2015-07-15	48,998,586,370	499,370,428,784	70,695,331	108,574,309	900,678,766	500,271,107,550
2015-07-14	44,837,686,658	502,165,088,913	47,528,878	116,865,969	979,455,259	503,144,544,172
2015-07-13	38,243,374,580	502,705,215,185	52,918,106	114,120,392	980,534,727	503,685,749,912
2015-07-10	27,011,987,685	505,945,776,955	69,685,177	115,325,727	956,330,881	506,902,107,836
2015-07-09	26,398,882,911	510,159,216,727	50,688,548	109,839,040	875,775,680	511,034,992,407
2015-07-08	15,906,182,294	515,212,343,591	56,075,451	124,035,462	883,521,852	516,095,865,443
2015-07-07	24,913,810,751	573,004,327,197	52,142,398	112,379,032	911,259,238	573,915,586,435
2015-07-06	48,178,914,259	619,037,358,022	103,342,005	136,524,693	1,103,564,058	620,140,922,080
2015-07-03	44,658,045,429	661,771,568,517	299,123,140	135,396,950	1,153,988,037	662,925,556,554
2015-07-02	47,321,103,534	685,837,823,740	540,431,101	171,425,545	1,466,448,908	687,304,272,648
2015-07-01	56,949,534,756	701,749,001,117	510,240,562	185,938,632	1,690,486,249	703,439,487,366
2015-06-30	57,798,561,189	709,162,691,967	610,388,236	185,076,010	1,757,399,394	710,920,091,361
2015-06-29	57,998,603,023	723,644,734,435	754,334,135	187,672,115	1,629,953,335	725,274,687,770
2015-06-26	48,864,721,395	738,707,126,516	566,505,382	184,624,774	1,714,239,476	740,421,365,992
2015-06-25	57,767,003,145	758,593,917,931	524,349,383	243,871,104	2,301,780,220	760,895,698,151
2015-06-24	57,601,491,190	766,627,175,015	594,975,097	238,183,139	2,256,618,737	768,883,793,752
2015-06-23	50,361,201,915	777,939,378,393	501,204,000	188,968,127	1,894,166,767	779,833,545,160
2015-06-19	52,613,840,026	781,785,835,539	429,820,050	194,995,098	1,833,178,936	783,619,014,475
2015-06-18	54,302,586,867	783,724,333,715	439,212,038	256,851,829	2,396,576,792	786,120,910,507
2015-06-17	57,647,973,869	779,939,203,269	506,215,806	270,451,450	2,599,119,307	782,538,322,576
2015-06-16	68,704,456,650	775,494,763,565	399,603,672	284,380,952	2,672,185,834	778,166,949,399
2015-06-15	78,928,671,819	771,159,310,316	439,921,656	320,242,856	3,105,634,844	774,264,945,160
2015-06-12	78,004,383,693	767,122,163,366	501,462,578	334,681,002	3,284,029,428	770,406,192,794
2015-06-11	75,806,602,169	761,979,456,459	427,364,164	335,290,268	3,278,375,214	765,257,831,673
2015-06-10	74,863,122,982	754,930,196,763	481,006,752	330,873,149	3,218,285,055	758,148,481,818
2015-06-09	72,503,163,533	748,477,647,040	397,050,637	328,628,067	3,141,874,234	751,619,521,274
2015-06-08	85,041,374,325	746,442,467,724	434,973,026	328,917,405	3,165,781,871	749,608,249,595
2015-06-05	92,631,968,257	748,157,582,936	418,672,454	316,675,686	3,030,093,245	751,187,676,181
2015-06-04	85,128,832,280	752,290,936,643	446,120,077	304,033,132	2,848,651,024	755,139,587,667
2015-06-03	83,282,082,170	747,086,620,524	434,872,507	289,585,694	2,857,001,726	749,943,622,250
2015-06-02	82,588,173,381	742,214,105,246	396,920,629	287,070,693	2,883,108,282	745,097,213,528
2015-06-01	76,378,089,561	733,007,153,665	534,477,739	292,858,602	2,856,370,736	735,863,524,401
2015-05-29	72,983,634,736	723,671,219,259	422,506,251	272,213,719	2,613,167,800	726,284,387,059
2015-05-28	107,427,530,431	722,038,309,273	423,946,926	301,618,225	2,812,599,180	724,850,908,453
2015-05-27	96,807,195,279	718,318,501,558	422,008,369	337,639,705	3,299,503,547	721,618,005,105
2015-05-26	103,458,479,356	713,150,293,302	444,643,538	368,146,680	3,465,510,608	716,615,803,910
2015-05-25	94,863,240,548	704,770,029,656	430,278,166	367,034,340	3,369,069,699	708,139,099,355
2015-05-22	95,129,790,587	699,421,477,055	462,979,173	345,150,261	3,080,219,511	702,501,696,566
2015-05-21	82,136,863,647	703,603,611,405	403,821,871	323,529,709	2,900,452,188	706,504,063,593
2015-05-20	90,847,217,448	695,732,198,743	451,102,502	294,236,211	2,619,081,393	698,351,280,136
2015-05-19	76,581,610,335	682,634,693,915	513,034,847	296,261,753	2,617,286,166	685,251,980,081
2015-05-18	66,046,414,496	668,894,577,990	468,306,251	303,155,507	2,603,193,058	671,497,771,048
2015-05-15	66,405,945,997	658,559,612,843	458,063,793	325,594,909	2,730,009,491	661,289,622,334
2015-05-14	74,221,882,394	654,928,816,141	471,997,042	350,005,857	2,937,569,269	657,866,385,410
2015-05-13	83,154,757,885	648,641,272,851	469,034,794	348,322,631	2,961,858,800	651,603,131,651
2015-05-12	78,369,189,860	638,556,990,053	428,842,507	340,728,490	2,903,865,717	641,460,855,770
2015-05-11	75,294,385,738	634,800,787,585	542,479,694	325,349,942	2,749,431,056	637,550,218,641
2015-05-08	53,164,484,221	629,920,926,522	404,161,650	266,275,976	2,265,422,560	632,186,349,082
2015-05-07	46,405,705,807	634,109,844,230	433,799,512	267,809,433	2,172,420,457	636,282,264,687
2015-05-06	60,906,907,976	631,054,246,062	512,732,447	303,481,684	2,413,249,355	633,467,495,417
2015-05-05	64,816,633,651	624,593,202,195	465,593,669	316,980,824	2,539,901,865	627,133,104,060
2015-05-04	59,481,464,470	615,989,564,964	401,255,695	373,377,992	3,040,818,126	619,030,383,090
2015-04-30	65,134,586,611	606,682,432,092	390,758,142	368,361,389	3,017,240,033	609,699,672,125
2015-04-29	65,407,486,554	604,040,735,304	496,015,480	371,173,804	3,087,185,923	607,127,921,227
2015-04-28	74,649,207,663	597,896,481,649	409,616,365	361,059,164	3,005,907,060	600,902,388,709
2015-04-27	75,863,303,973	595,346,164,786	495,880,929	382,235,136	3,196,091,290	598,542,256,076
2015-04-24	76,169,130,205	588,116,857,679	427,961,969	369,574,380	3,052,072,824	591,168,930,503
2015-04-23	81,592,776,204	583,954,018,000	473,751,321	371,342,955	3,123,824,480	587,077,842,480
2015-04-22	79,322,143,124	579,014,805,811	486,271,237	373,347,999	3,138,872,016	582,153,677,827
2015-04-21	68,385,035,141	576,547,480,301	538,328,897	360,746,047	2,950,727,296	579,498,207,597
2015-04-20	78,017,172,912	573,835,282,051	498,586,432	348,021,544	2,742,050,269	576,577,332,320
2015-04-17	70,769,195,200	575,980,304,237	504,722,331	356,680,372	2,843,849,931	578,824,154,168
2015-04-16	54,538,805,711	580,313,399,643	429,185,996	341,914,406	2,724,163,171	583,037,562,814
2015-04-15	65,204,872,955	575,375,934,708	432,041,797	335,933,076	2,616,345,990	577,992,280,698
2015-04-14	69,349,225,871	566,988,822,226	491,757,530	344,502,232	2,808,226,817	569,797,049,043
2015-04-13	72,802,345,092	559,273,638,521	468,240,947	363,008,446	2,932,318,981	562,205,957,502
2015-04-10	65,937,150,651	549,425,865,491	450,801,200	373,732,017	2,973,504,472	552,399,369,963
2015-04-09	76,120,386,757	542,269,865,845	476,544,087	365,528,545	2,852,037,480	545,121,903,325
2015-04-08	80,029,308,212	534,127,452,357	445,994,387	387,788,700	3,034,345,778	537,161,798,135
2015-04-07	76,411,247,986	527,220,275,303	426,168,950	397,736,318	3,121,859,985	530,342,135,288
2015-04-03	72,768,292,844	516,676,930,961	372,632,372	381,957,722	2,977,171,835	519,654,102,796
2015-04-02	71,263,078,124	509,988,379,711	420,837,622	368,945,154	2,870,700,924	512,859,080,635
2015-04-01	66,032,640,455	502,453,651,639	443,562,681	364,316,957	2,857,234,816	505,310,886,455
2015-03-31	68,420,906,330	493,765,560,657	393,155,982	338,886,850	2,628,145,327	496,393,705,984
2015-03-30	61,710,664,790	489,166,892,146	373,054,952	356,576,053	2,729,213,200	491,896,105,346
2015-03-27	49,474,009,451	484,087,216,047	342,580,626	334,795,365	2,558,214,628	486,645,430,675
2015-03-26	64,379,996,644	480,092,915,137	396,144,870	324,099,949	2,457,863,759	482,550,778,896
2015-03-25	72,150,523,501	475,561,580,264	370,579,663	314,743,397	2,453,452,221	478,015,032,485
2015-03-24	79,907,649,786	465,149,520,648	390,946,343	312,335,439	2,424,227,164	467,573,747,812
2015-03-23	66,646,329,157	456,468,114,455	392,789,862	321,474,072	2,461,658,730	458,929,773,185
2015-03-20	62,900,138,777	449,976,925,205	393,858,548	304,350,559	2,301,310,757	452,278,235,962
2015-03-19	58,208,444,120	445,156,834,921	307,707,743	281,311,862	2,185,054,379	447,341,889,300
2015-03-18	61,433,866,336	439,079,318,940	443,850,638	290,072,802	2,229,156,054	441,308,474,994
2015-03-17	61,492,982,750	432,620,976,886	443,646,862	273,539,023	2,081,796,516	434,702,773,402
2015-03-16	51,817,200,508	430,037,375,813	438,957,290	268,341,650	1,971,019,595	432,008,395,408
2015-03-13	37,807,633,718	431,586,133,514	317,434,825	225,945,311	1,672,140,493	433,258,274,007
2015-03-12	42,983,488,621	430,130,407,909	359,215,537	221,427,662	1,636,224,538	431,766,632,447
2015-03-11	39,828,994,953	422,017,577,470	399,421,741	215,420,060	1,607,738,035	423,625,315,505
2015-03-10	41,198,368,628	413,963,887,171	429,948,612	226,608,594	1,729,680,246	415,693,567,417'''


def test():
    x = []
    y1 = []
    y2 = []
    y3 = []
    y4 = []
    y5 = []
    y6 = []
    y7 = []
    y8 = []

    last_rongzi_balance = 0
    for line in data.split('\n'):
        date, rongzi_buy, rongzi_balance, rongquan_sell_liang, rongquan_balance_liang, rongquan_balance, rong_all_balance = line.split('\t')

        price = get_stock_history_by_date('399001.SZ', date)
        if not price:
            price_close = 0
        else:
            price_close = price['close']

            return_today = last_rongzi_balance + int(rongzi_buy.replace(',', '')) - int(rongzi_balance.replace(',', ''))

            x.append(date[-2:])
            y1.append(int(rongzi_buy.replace(',', '')))
            y2.append(int(rongzi_balance.replace(',', '')))
            y3.append(int(rongquan_sell_liang.replace(',', '')))
            y4.append(int(rongquan_balance_liang.replace(',', '')))
            y5.append(int(rongquan_balance.replace(',', '')))
            y6.append(int(rong_all_balance.replace(',', '')))
            y7.append(float(price_close))
            y8.append(return_today)

        last_rongzi_balance = int(rongzi_balance.replace(',', ''))

    x.reverse()
    y1.reverse()
    y2.reverse()
    y3.reverse()
    y4.reverse()
    y5.reverse()
    y6.reverse()
    y7.reverse()
    y8.reverse()

    line_chart = pygal.Line(width=1600, height=800)
    line_chart.title = 'rong'
    line_chart.x_labels = x
    line_chart.add('rongzi_buy', y1)
    line_chart.add('rongzi_return', y8)
    line_chart.add('rongzi_balance', data_standard(y2), secondary=True)
    # line_chart.add('rongquan_sell_liang', data_standard(y3))
    # line_chart.add('rongquan_balance_liang', data_standard(y4))
    # line_chart.add('rongquan_balance', data_standard(y5))
    # line_chart.add('rong_all_balance', data_standard(y6))
    # line_chart.add('rong_all_balance', data_standard(y6))

    # line_chart.add('399001', data_standard(y7), secondary=True)

    line_chart.render_to_file('all.svg')


if __name__ == '__main__':
    # calc_rong_svg('002312')
    test()